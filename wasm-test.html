<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebAssembly ãƒ†ã‚¹ãƒˆ</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background: #f9f9f9;
        }
        .result {
            margin: 10px 0;
            padding: 10px;
            background: #fff;
            border-left: 4px solid #007cba;
        }
        .success { border-left-color: #28a745; }
        .error { border-left-color: #dc3545; }
        .warning { border-left-color: #ffc107; }
        button {
            background: #007cba;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #005a87; }
        .log {
            background: #2d3748;
            color: #e2e8f0;
            padding: 10px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <h1>ğŸ¦€ WebAssembly å‹•ä½œç¢ºèªãƒ†ã‚¹ãƒˆ</h1>
    
    <div class="test-section">
        <h2>ğŸ“¦ WebAssembly ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«èª­ã¿è¾¼ã¿ãƒ†ã‚¹ãƒˆ</h2>
        <button onclick="testWasmLoading()">WebAssemblyã‚’èª­ã¿è¾¼ã‚€</button>
        <div id="wasm-loading-result" class="result"></div>
    </div>

    <div class="test-section">
        <h2>ğŸ§ª åŸºæœ¬é–¢æ•°ãƒ†ã‚¹ãƒˆ</h2>
        <button onclick="testBasicFunctions()">åŸºæœ¬é–¢æ•°ã‚’ãƒ†ã‚¹ãƒˆ</button>
        <div id="basic-functions-result" class="result"></div>
    </div>

    <div class="test-section">
        <h2>ğŸ”„ SeedCalculator çµ±åˆãƒ†ã‚¹ãƒˆ</h2>
        <button onclick="testSeedCalculator()">SeedCalculatorã‚’ãƒ†ã‚¹ãƒˆ</button>
        <div id="seed-calculator-result" class="result"></div>
    </div>

    <div class="test-section">
        <h2>âš¡ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆ</h2>
        <button onclick="testPerformance()">ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ</button>
        <div id="performance-result" class="result"></div>
    </div>

    <div class="test-section">
        <h2>ğŸ® å®Ÿéš›ã®ã‚²ãƒ¼ãƒ ã‚·ãƒŠãƒªã‚ªãƒ†ã‚¹ãƒˆ</h2>
        <button onclick="testGameScenario()">ã‚²ãƒ¼ãƒ ã‚·ãƒŠãƒªã‚ªãƒ†ã‚¹ãƒˆå®Ÿè¡Œ</button>
        <div id="game-scenario-result" class="result"></div>
    </div>

    <div class="test-section">
        <h2>ğŸ“ ãƒ­ã‚°</h2>
        <div id="log" class="log"></div>
        <button onclick="clearLog()">ãƒ­ã‚°ã‚¯ãƒªã‚¢</button>
    </div>

    <script type="module">
        import { SeedCalculator } from './src/lib/seed-calculator.ts';
        import { initWasm, getWasm } from './src/lib/wasm-interface.ts';

        let calculator = null;
        let wasmModule = null;

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logDiv = document.getElementById('log');
            const prefix = {
                'info': 'ğŸ“',
                'success': 'âœ…',
                'error': 'âŒ',
                'warning': 'âš ï¸'
            }[type] || 'ğŸ“';
            
            logDiv.textContent += `[${timestamp}] ${prefix} ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }

        function setResult(elementId, message, isSuccess) {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = `result ${isSuccess ? 'success' : 'error'}`;
        }

        window.testWasmLoading = async function() {
            log('WebAssembly ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®èª­ã¿è¾¼ã¿ã‚’é–‹å§‹...');
            try {
                wasmModule = await initWasm();
                calculator = new SeedCalculator();
                const wasmInitialized = await calculator.initializeWasm();
                
                if (wasmInitialized && wasmModule) {
                    const testResult = wasmModule.test_wasm();
                    setResult('wasm-loading-result', `WebAssembly èª­ã¿è¾¼ã¿æˆåŠŸ: ${testResult}`, true);
                    log(`WebAssembly ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«èª­ã¿è¾¼ã¿æˆåŠŸ: ${testResult}`, 'success');
                } else {
                    setResult('wasm-loading-result', 'WebAssembly èª­ã¿è¾¼ã¿å¤±æ•—ï¼ˆTypeScriptå®Ÿè£…ã‚’ä½¿ç”¨ï¼‰', false);
                    log('WebAssembly èª­ã¿è¾¼ã¿å¤±æ•—ã€TypeScriptå®Ÿè£…ã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯', 'warning');
                }
            } catch (error) {
                setResult('wasm-loading-result', `ã‚¨ãƒ©ãƒ¼: ${error.message}`, false);
                log(`WebAssembly èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        };

        window.testBasicFunctions = async function() {
            if (!wasmModule) {
                setResult('basic-functions-result', 'WebAssemblyãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“', false);
                return;
            }

            try {
                log('åŸºæœ¬é–¢æ•°ã®ãƒ†ã‚¹ãƒˆã‚’é–‹å§‹...');
                
                // ã‚¨ãƒ³ãƒ‡ã‚£ã‚¢ãƒ³å¤‰æ›ãƒ†ã‚¹ãƒˆ
                const endian32 = wasmModule.to_little_endian_32(0x12345678);
                const endian16 = wasmModule.to_little_endian_16(0x1234);
                log(`ã‚¨ãƒ³ãƒ‡ã‚£ã‚¢ãƒ³å¤‰æ›: 32bit=0x${endian32.toString(16)}, 16bit=0x${endian16.toString(16)}`);

                // SHA-1ãƒãƒƒã‚·ãƒ¥ãƒ†ã‚¹ãƒˆ
                const testMessage = new Uint32Array([0x12345678, 0x9ABCDEF0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]);
                const hashResult = wasmModule.calculate_sha1_hash(testMessage);
                log(`SHA-1ãƒãƒƒã‚·ãƒ¥: [${hashResult[0].toString(16)}, ${hashResult[1].toString(16)}]`);

                // ãƒãƒƒãƒè¨ˆç®—ãƒ†ã‚¹ãƒˆ
                const batchMessages = new Uint32Array(32); // 2ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ x 16è¦ç´ 
                batchMessages.set([0x11111111, 0x22222222, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], 0);
                batchMessages.set([0x33333333, 0x44444444, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], 16);
                const batchResult = wasmModule.calculate_sha1_batch(batchMessages, 2);
                log(`ãƒãƒƒãƒè¨ˆç®—: [${batchResult.map(x => x.toString(16)).join(', ')}]`);

                setResult('basic-functions-result', 'å…¨ã¦ã®åŸºæœ¬é–¢æ•°ãŒæ­£å¸¸ã«å‹•ä½œã—ã¾ã—ãŸ', true);
                log('åŸºæœ¬é–¢æ•°ãƒ†ã‚¹ãƒˆå®Œäº†', 'success');
            } catch (error) {
                setResult('basic-functions-result', `ã‚¨ãƒ©ãƒ¼: ${error.message}`, false);
                log(`åŸºæœ¬é–¢æ•°ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        };

        window.testSeedCalculator = async function() {
            if (!calculator) {
                setResult('seed-calculator-result', 'SeedCalculatorãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“', false);
                return;
            }

            try {
                log('SeedCalculator çµ±åˆãƒ†ã‚¹ãƒˆã‚’é–‹å§‹...');
                
                const isUsingWasm = calculator.isUsingWasm();
                log(`å®Ÿè£…: ${isUsingWasm ? 'WebAssembly' : 'TypeScript'}`);

                // ãƒ†ã‚¹ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã§ã®è¨ˆç®—
                const testMessage = [0x12345678, 0x9ABCDEF0, 0x11111111, 0x22222222,
                                   0x33333333, 0x44444444, 0x55555555, 0x66666666,
                                   0x77777777, 0x88888888, 0x99999999, 0xAAAAAAAA,
                                   0xBBBBBBBB, 0xCCCCCCCC, 0xDDDDDDDD, 0xEEEEEEEE];

                const result = calculator.calculateSeed(testMessage);
                log(`è¨ˆç®—çµæœ: seed=0x${result.seed.toString(16)}, hash=${result.hash}`);

                // ä¸€è²«æ€§ãƒ†ã‚¹ãƒˆ
                const result2 = calculator.calculateSeed(testMessage);
                const isConsistent = result.seed === result2.seed && result.hash === result2.hash;
                log(`ä¸€è²«æ€§ãƒ†ã‚¹ãƒˆ: ${isConsistent ? 'æˆåŠŸ' : 'å¤±æ•—'}`);

                setResult('seed-calculator-result', 
                    `SeedCalculatorå‹•ä½œç¢ºèªå®Œäº† (${isUsingWasm ? 'WebAssembly' : 'TypeScript'})\\n` +
                    `Seed: 0x${result.seed.toString(16)}\\n` +
                    `Hash: ${result.hash}\\n` +
                    `ä¸€è²«æ€§: ${isConsistent ? 'âœ“' : 'âœ—'}`, true);
                
                log('SeedCalculator çµ±åˆãƒ†ã‚¹ãƒˆå®Œäº†', 'success');
            } catch (error) {
                setResult('seed-calculator-result', `ã‚¨ãƒ©ãƒ¼: ${error.message}`, false);
                log(`SeedCalculator ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        };

        window.testPerformance = async function() {
            if (!calculator) {
                setResult('performance-result', 'SeedCalculatorãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“', false);
                return;
            }

            try {
                log('ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆã‚’é–‹å§‹...');
                
                const testMessage = [0x12345678, 0x9ABCDEF0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0];
                const iterations = 10000;
                
                const startTime = performance.now();
                
                for (let i = 0; i < iterations; i++) {
                    calculator.calculateSeed(testMessage);
                }
                
                const endTime = performance.now();
                const elapsedTime = endTime - startTime;
                const calcPerSec = Math.round(iterations / elapsedTime * 1000);
                
                const implementation = calculator.isUsingWasm() ? 'WebAssembly' : 'TypeScript';
                log(`${implementation}: ${iterations}å›è¨ˆç®— = ${elapsedTime.toFixed(1)}ms (${calcPerSec} calc/sec)`);
                
                setResult('performance-result', 
                    `ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆå®Œäº†\\n` +
                    `å®Ÿè£…: ${implementation}\\n` +
                    `${iterations}å›è¨ˆç®—: ${elapsedTime.toFixed(1)}ms\\n` +
                    `æ€§èƒ½: ${calcPerSec.toLocaleString()} calc/sec`, true);
                
                log('ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆå®Œäº†', 'success');
            } catch (error) {
                setResult('performance-result', `ã‚¨ãƒ©ãƒ¼: ${error.message}`, false);
                log(`ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        };

        window.testGameScenario = async function() {
            if (!calculator) {
                setResult('game-scenario-result', 'SeedCalculatorãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“', false);
                return;
            }

            try {
                log('å®Ÿéš›ã®ã‚²ãƒ¼ãƒ ã‚·ãƒŠãƒªã‚ªãƒ†ã‚¹ãƒˆã‚’é–‹å§‹...');
                
                // ãƒã‚±ãƒ¢ãƒ³BW JPNç‰ˆã®å…¸å‹çš„ãªã‚·ãƒŠãƒªã‚ª
                const conditions = {
                    romVersion: 'B',
                    romRegion: 'JPN',
                    hardware: 'DS',
                    timer0Range: { min: 1000, max: 1000, useAutoRange: false },
                    vcountRange: { min: 95, max: 95, useAutoRange: false },
                    dateRange: {
                        startYear: 2011, startMonth: 3, startDay: 6,
                        startHour: 12, startMinute: 0, startSecond: 0,
                        endYear: 2011, endMonth: 3, endDay: 6,
                        endHour: 12, endMinute: 0, endSecond: 0
                    },
                    keyInput: 0,
                    macAddress: [0x00, 0x09, 0xBF, 0x12, 0x34, 0x56]
                };

                const datetime = new Date(2011, 2, 6, 12, 0, 0); // 2011/03/06 12:00:00
                
                // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ç”Ÿæˆ
                const message = calculator.generateMessage(conditions, 1000, 95, datetime);
                log(`ç”Ÿæˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸: [${message.slice(0, 4).map(x => '0x' + x.toString(16)).join(', ')}, ...]`);

                // ã‚·ãƒ¼ãƒ‰è¨ˆç®—
                const result = calculator.calculateSeed(message);
                log(`è¨ˆç®—çµæœ: seed=0x${result.seed.toString(16)}, hash=${result.hash}`);

                // è¤‡æ•°ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒ†ã‚¹ãƒˆ
                const testResults = [];
                for (let timer0 = 1000; timer0 <= 1002; timer0++) {
                    const msg = calculator.generateMessage(conditions, timer0, 95, datetime);
                    const res = calculator.calculateSeed(msg);
                    testResults.push(`Timer0=${timer0}: 0x${res.seed.toString(16)}`);
                }
                
                log(`è¤‡æ•°ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒ†ã‚¹ãƒˆ: ${testResults.join(', ')}`);

                const implementation = calculator.isUsingWasm() ? 'WebAssembly' : 'TypeScript';
                
                setResult('game-scenario-result', 
                    `ã‚²ãƒ¼ãƒ ã‚·ãƒŠãƒªã‚ªãƒ†ã‚¹ãƒˆå®Œäº†\\n` +
                    `å®Ÿè£…: ${implementation}\\n` +
                    `Date: 2011/03/06 12:00:00\\n` +
                    `Timer0=1000, VCount=95\\n` +
                    `çµæœ: 0x${result.seed.toString(16)}\\n` +
                    `Hash: ${result.hash}`, true);
                
                log('ã‚²ãƒ¼ãƒ ã‚·ãƒŠãƒªã‚ªãƒ†ã‚¹ãƒˆå®Œäº†', 'success');
            } catch (error) {
                setResult('game-scenario-result', `ã‚¨ãƒ©ãƒ¼: ${error.message}`, false);
                log(`ã‚²ãƒ¼ãƒ ã‚·ãƒŠãƒªã‚ªãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        };

        window.clearLog = function() {
            document.getElementById('log').textContent = '';
        };

        // åˆæœŸåŒ–
        log('ãƒ†ã‚¹ãƒˆãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†');
        log('WebAssemblyãƒ†ã‚¹ãƒˆã‚’é–‹å§‹ã™ã‚‹ã«ã¯ã€å„ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„');
    </script>
</body>
</html>
